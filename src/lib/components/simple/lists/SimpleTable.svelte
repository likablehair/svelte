<script context="module" lang="ts">
  export type Header = {
    value: string
    label: string
    type: "boolean" | "string" | "number" | "date" | "custom"
    width?: string
    minWidth?: string
    sortable?: boolean
    /* eslint-disable  @typescript-eslint/no-explicit-any */
    data?: { [key: string]: any }
  };
</script>

<script lang="ts">
  import '../../../css/main.css'
  import './SimpleTable.css'
  import { dateToString } from "$lib/components/simple/dates/utils";
  import Icon from '../media/Icon.svelte';
  import { createEventDispatcher } from 'svelte';

  let clazz: {
    container?: string,
    header?: string,
    row?: string,
    cell?: string
  } = {};
	export { clazz as class };

  const dispatch = createEventDispatcher<{
    'sort': {
      sortedBy: string | undefined,
      sortDirection: string
    }
  }>()

  export let headers: Header[] = [],
    items: { [key: string]: any }[] = [],
    sortedBy: string | undefined = undefined,
    sortDirection: 'asc' | 'desc' = 'asc'

  function handleHeaderClick(header: Header) {
    if(!!sortedBy && header.value == sortedBy) {
      if(sortDirection == 'asc') sortDirection = 'desc'
      else if(sortDirection == 'desc') {
        sortedBy = undefined
      }
    } else {
      sortedBy = header.value
      sortDirection = 'asc'
    }
    dispatch('sort', {
      sortedBy, sortDirection
    })
  }
</script>

{#if !!items && Array.isArray(items)}
  <div class="simple-table-container {clazz.container || ''}" >
    <table class="table">
      <thead class="thead {clazz.header || ''}">
        <tr>
          {#each headers as head}
            <th 
              style:width={head.width} 
              style:min-width={head.minWidth}
              class:sortable={head.sortable}
              on:click={() => handleHeaderClick(head)}
            >
              <slot name="header" {head}>
                <span class="header-label">
                  <slot name="headerLabel">
                    {head.label}
                  </slot>
                </span>
                {#if head.sortable}
                  <span 
                    class="header-sort-icon"
                    class:active={sortedBy == head.value}
                    class:asc={sortDirection == 'asc'}
                    class:desc={sortDirection == 'desc'}
                  >
                    {#if sortDirection == 'asc'}
                      <Icon name="mdi-arrow-up"></Icon>
                    {:else}
                      <Icon name="mdi-arrow-down"></Icon>
                    {/if}
                  </span>
                {/if}
              </slot>
            </th>
          {/each}
          {#if $$slots.rowActions || $$slots.append}
            <th>
              <slot name="append" index={-1} items={undefined} />
            </th>
          {/if}
        </tr>
      </thead>
      <tbody>
        {#each items as item, i}
          <tr class="item-tr {clazz.row || ''}">
            {#each headers as header, j}
              <td class="{clazz.cell || ''}">
                {#if header.type == "custom"}
                  <slot
                    name="custom"
                    index={i}
                    columnIndex={j}
                    {header}
                    {item}
                  />
                {:else if header.type == "date"}
                  {dateToString(item[header.value], "dayAndHours", "it")}
                {:else}
                  {item[header.value]}
                {/if}
              </td>
            {/each}
            {#if $$slots.rowActions || $$slots.append}
              <td class="{clazz.cell || ''}">
                <slot name="rowActions" index={i} {item} />
                <slot name="append" index={i} {item} />
              </td>
            {/if}
          </tr>
        {/each}
      </tbody>
    </table>
  </div>
{/if}

<style>
  .simple-table-container {
    width: var(
      --simple-table-width,
      var(--simple-table-default-width)
    );
    min-width: var(
      --simple-table-min-width,
      var(--simple-table-default-min-width)
    );
    max-width: var(
      --simple-table-max-width,
      var(--simple-table-default-max-width)
    );
    height: var(
      --simple-table-height,
      var(--simple-table-default-height)
    );
    min-height: var(
      --simple-table-min-height,
      var(--simple-table-default-min-height)
    );
    max-height: var(
      --simple-table-max-height,
      var(--simple-table-default-max-height)
    );
  }

  .table {
    background-color: var(
      --simple-table-background-color,
      var(--simple-table-default-background-color)
    );
  }

  .thead th {
    background-color: var(
      --simple-table-header-background-color,
      var(--simple-table-default-header-background-color)
    );
    padding: var(
      --simple-table-header-padding,
      var(--simple-table-default-header-padding)
    );
    font-size: var(
      --simple-table-header-font-size,
      var(--simple-table-default-header-font-size)
    );
    font-weight: var(
      --simple-table-header-font-weight,
      var(--simple-table-default-header-font-weight)
    );
  }

  .thead th.sortable {
    cursor: pointer;
    transition: all .1s ease-in;
    user-select: none;
  }

  .thead th.sortable:hover {
    color: var(
      --simple-table-header-hover-color,
      var(--simple-table-default-hover-color)
    );
  }

  .header-label {
    margin-right: 5px;
  }

  .header-sort-icon {
    display: none;
  }

  .header-sort-icon.active {
    display: inline;
  }

  .thead th:first-child {
    border-top-left-radius: var(
      --simple-table-header-border-radius,
      var(--simple-table-default-header-border-radius)
    );
    border-bottom-left-radius: var(
      --simple-table-header-border-radius,
      var(--simple-table-default-header-border-radius)
    );
  }

  .thead th:last-child {
    border-top-right-radius: var(
      --simple-table-header-border-radius,
      var(--simple-table-default-header-border-radius)
    );
    border-bottom-right-radius: var(
      --simple-table-header-border-radius,
      var(--simple-table-default-header-border-radius)
    );
  }

  .thead {
    height: var(
      --simple-table-header-height,
      var(--simple-table-default-header-height)
    );
  }

  .item-tr {
    border-bottom: solid;
    border-width: 1px 0;
    border-color: var(
      --simple-table-separator-color,
      var(--simple-table-default-separator-color)
    );
    height: var(
      --simple-table-row-height,
      var(--simple-table-default-row-height)
    );
    transition: background-color .1s ease-in-out;
  }

  .item-tr:hover {
    background-color: var(
      --simple-table-row-hover-background-color,
      var(--simple-table-default-row-hover-background-color)
    );
  }

  table {
    border-collapse: collapse;
    width: 100%;
  }

  th {
    text-align: start;
    padding-left: 10px;
    min-width: 100px;
  }

  td {
    padding-left: 10px;
  }
</style>
